![Firebase Logo](https://gregnz.com/images/firebase_logo.png)

# Firebase Token Generation and Authorization for C#

More info on verifying Firebase tokens with 3rd party libraries can be found here:
https://firebase.google.com/docs/auth/admin/verify-id-tokens

## Requirements

.NET Core >= 2.0
Firebase V3

## Installation Instructions

### For Tokens generated by Firebase

1. Get the Nuget package from here: https://www.nuget.org/packages/FirebaseAuth/

2. If you're not implementing your own authorization store, you will need your Firebase Project Id (this can be found in Firebase Console). Ask Google if you have any trouble finding it. In Startup.cs add the following configuration.  

```csharp
public void ConfigureServices(IServiceCollection services)
{
    // required for Firebase Auth
    void options(FirebaseAuthenticationOptions o)
    {
        o.FirebaseProjectId = "your project id (can be found in firebase console)";
        o.SignInWithCustomTokenMode = false;
        o.ExceptionLogger = (Exception ex) =>
        {
            // Set up exception logging here. 
        };
    }

    // Required for Firebase Auth. Place above AddMvc()
    services.AddAuthentication(o =>
    {
        o.DefaultScheme = "Default";
    }).AddScheme<FirebaseAuthenticationOptions, FirebaseAuthenticationHandler>("Default", options);

    services.AddMvc();
}
        
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    // required for Firebase Auth
    app.UseAuthentication();
    
    app.UseMvc();
}
```
### For custom Authorization store

1. Get the Nuget package from here: https://www.nuget.org/packages/FirebaseAuth/

2. A few extra steps are needed here. In Firebase console click the cog in top left corner and then go to "Users and permissions".

2.1 Click on the "Service Accounts" tab at the top. 

2.2 Click on "Manage all service accounts".

2.3 Click "Create service account".

2.4 Enter a Service account name.

2.5 For Project role, select "Project -> Editor".

2.6 Tick the check box "Furnish a new private key".

2.7 Select the key type "JSON" (it should already be selected).

2.8 Click save and open the downloaded JSON file. 

2.9 Take note of the "private_key" and "client_email" values. You might want to put these into appsettings.json. 


3. In Startup.cs add the following configuration.  

```csharp
public void ConfigureServices(IServiceCollection services)
{

    // If you're using Identity - include this statement.
    JwtSecurityTokenHandler.DefaultInboundClaimTypeMap.Clear();

    // Required for Firebase Auth. Place above AddMvc()
    services.AddAuthentication(o =>
    {
        o.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
        o.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
        o.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    }).AddScheme<FirebaseAuthenticationOptions, FirebaseAuthenticationHandler>(JwtBearerDefaults.AuthenticationScheme,           firebaseAuthOptions);

    services.AddMvc();
}
        
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    // required for Firebase Auth
    app.UseAuthentication();
    
    app.UseMvc();
}
```

4. Generating a token. To generate a token, you will need your private_key and client_email. Also note that the maximum expiry for a custom Firebase token is 60 minutes. You might want to think about a refresh token strategy. 

4.1 Instantiate a new instance of FirebaseAuthenticationHelper.

Here is example usage...

```csharp
string privateKey = @"-----BEGIN PRIVATE KEY--.... Your private key\n";
string clientEmail = @"your client email";
var firebaseHelper = new FirebaseAuthenticationHelper(privateKey, clientEmail);
var token = firebaseHelper.GenerateToken("testuser");
```

## Authorizing client
On the client side you will need to add an "Authorization" header to your requests. Prepend the token with "Bearer ".

```javascript
firebase.auth().onAuthStateChanged(function (user) {
    if (user) {
        user.getIdToken(true).then(function (token) {
        const headers = { Authorization: `Bearer ${token}` };
          
        // add the above header to your request
      }
    });
```

For all actions/controllers, you can now start guarding with the **[Authorize]** filter. You can also specify Roles.  

That's it. If you have any questions, please ask.
